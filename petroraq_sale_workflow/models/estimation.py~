from odoo import api, fields, models, _
from odoo.exceptions import UserError, ValidationError


SECTION_TYPES = [
    ("material", "Material"),
    ("labor", "Labor"),
    ("equipment", "Equipment"),
    ("subcontract", "Sub Contract / TPS"),
]


class PetroraqEstimation(models.Model):
    _name = "petroraq.estimation"
    _description = "Estimation"
    _inherit = ["mail.thread", "mail.activity.mixin"]

    approval_state = fields.Selection(
        [
            ("draft", "Draft"),
            ("to_manager", "Manager Approve"),
            ("to_md", "MD Approve"),
            ("approved", "Approved"),
            ("rejected", "Rejected"),
        ],
        default="draft",
        tracking=True,
        copy=False,
    )
    approval_comment = fields.Text("Approval Comment", tracking=True)
    show_reject_button = fields.Boolean(compute="_compute_show_reject_button")

    name = fields.Char(
        string="Estimation",
        required=True,
        copy=False,
        readonly=True,
        default=lambda self: _("New"),
    )
    partner_id = fields.Many2one("res.partner", string="Customer", required=True, tracking=True)
    date = fields.Date(string="Date", default=fields.Date.context_today, tracking=True)
    company_id = fields.Many2one(
        "res.company",
        string="Company",
        required=True,
        default=lambda self: self.env.company,
    )
    currency_id = fields.Many2one(
        "res.currency",
        string="Currency",
        related="company_id.currency_id",
        store=True,
        readonly=True,
    )
    line_ids = fields.One2many(
        "petroraq.estimation.line",
        "estimation_id",
        string="Estimation Lines",
    )
    sale_order_id = fields.Many2one("sale.order", string="Quotation", readonly=True, copy=False)

    material_total = fields.Monetary(
        string="Material Total",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    labor_total = fields.Monetary(
        string="Labor Total",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    equipment_total = fields.Monetary(
        string="Equipment Total",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    subcontract_total = fields.Monetary(
        string="Sub Contract / TPS Total",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    total_amount = fields.Monetary(
        string="Total",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    overhead_percent = fields.Float(
        string="Over Head (%)",
        default=0.0,
        digits=(16, 2),
    )
    risk_percent = fields.Float(
        string="Risk (%)",
        default=0.0,
        digits=(16, 2),
    )
    profit_percent = fields.Float(
        string="Profit (%)",
        default=0.0,
        digits=(16, 2),
    )
    overhead_amount = fields.Monetary(
        string="Over Head Amount",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    risk_amount = fields.Monetary(
        string="Risk Amount",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    buffer_total_amount = fields.Monetary(
        string="Computed Total Amount",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
        help="Total amount including overhead and risk (no profit).",
    )
    profit_amount = fields.Monetary(
        string="Profit Amount",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )
    total_with_profit = fields.Monetary(
        string="Total With Profit",
        compute="_compute_totals",
        currency_field="currency_id",
        store=False,
    )

    @api.model
    def create(self, vals):
        if vals.get("name", _("New")) == _("New"):
            vals["name"] = self.env["ir.sequence"].next_by_code("petroraq.estimation") or _("New")
        return super().create(vals)

    @api.depends_context("uid")
    @api.depends("approval_state")
    def _compute_show_reject_button(self):
        user = self.env.user
        for record in self:
            record.show_reject_button = (
                (record.approval_state == "to_manager" and user.has_group(
                    "petroraq_sale_workflow.group_sale_approval_manager"))
                or
                (record.approval_state == "to_md" and user.has_group(
                    "petroraq_sale_workflow.group_sale_approval_md"))
            )

    @api.depends(
        "line_ids.subtotal",
        "line_ids.section_type",
        "overhead_percent",
        "risk_percent",
        "profit_percent",
    )
    def _compute_totals(self):
        for record in self:
            totals = {
                "material": 0.0,
                "labor": 0.0,
                "equipment": 0.0,
                "subcontract": 0.0,
            }
            for line in record.line_ids:
                totals[line.section_type] += line.subtotal
            record.material_total = totals["material"]
            record.labor_total = totals["labor"]
            record.equipment_total = totals["equipment"]
            record.subcontract_total = totals["subcontract"]
            base_total = sum(totals.values())
            overhead_amount = base_total * (record.overhead_percent or 0.0) / 100.0
            risk_amount = base_total * (record.risk_percent or 0.0) / 100.0
            buffer_total = base_total + overhead_amount + risk_amount
            profit_amount = buffer_total * (record.profit_percent or 0.0) / 100.0

            record.total_amount = base_total
            record.overhead_amount = overhead_amount
            record.risk_amount = risk_amount
            record.buffer_total_amount = buffer_total
            record.profit_amount = profit_amount
            record.total_with_profit = buffer_total + profit_amount

    @api.onchange("overhead_percent", "risk_percent", "profit_percent")
    def _onchange_percent_validation(self):
        for field in ("overhead_percent", "risk_percent", "profit_percent"):
            value = self[field]
            if value < 0:
                raise UserError(_("Percentage cannot be negative."))
            if value > 100:
                raise UserError(_("Percentage cannot exceed 100%."))

    @api.constrains("overhead_percent", "risk_percent", "profit_percent")
    def _check_percentages(self):
        for record in self:
            for field_name in ("overhead_percent", "risk_percent", "profit_percent"):
                value = record[field_name]
                if value < 0:
                    raise ValidationError(_("Percentage cannot be negative."))
                if value > 100:
                    raise ValidationError(_("Percentage cannot exceed 100%."))

    def action_create_sale_order(self):
        self.ensure_one()
        if self.approval_state != "approved":
            raise UserError(_("You can only create a quotation after final approval."))
        if not self.partner_id:
            raise UserError(_("Please set a customer before creating a quotation."))
        if self.sale_order_id:
            return {
                "type": "ir.actions.act_window",
                "name": _("Quotation"),
                "res_model": "sale.order",
                "res_id": self.sale_order_id.id,
                "view_mode": "form",
                "target": "current",
            }

        term = self.env.ref("petroraq_sale_workflow.payment_term_immediate", raise_if_not_found=False)
        order_vals = {
            "partner_id": self.partner_id.id,
            "company_id": self.company_id.id,
            "currency_id": self.currency_id.id,
            "inquiry_type": "construction",
            "payment_term_id": term.id if term else False,
        }
        if self.order_inquiry_id:
            order_vals["order_inquiry_id"] = self.order_inquiry_id.id
        order = self.env["sale.order"].create(order_vals)

        self.sale_order_id = order.id

        return {
            "type": "ir.actions.act_window",
            "name": _("Quotation"),
            "res_model": "sale.order",
            "res_id": order.id,
            "view_mode": "form",
            "target": "current",
        }

    def action_confirm_estimation(self):
        for record in self:
            if not record.line_ids:
                raise UserError(_("Please add at least one estimation line."))
            record.approval_state = "to_manager"
            record.approval_comment = False

    def action_manager_approve(self):
        for record in self:
            if record.approval_state != "to_manager":
                raise UserError(_("This estimation is not awaiting manager approval."))
            record.approval_state = "to_md"

    def action_md_approve(self):
        for record in self:
            if record.approval_state != "to_md":
                raise UserError(_("This estimation is not awaiting MD approval."))
            record.approval_state = "approved"

    def action_reject(self):
        for record in self:
            if record.approval_state not in ("to_manager", "to_md", "draft"):
                raise UserError(_("Only waiting approvals can be rejected."))
            record.approval_state = "rejected"

    def action_reset_to_draft(self):
        for record in self:
            if record.approval_state == "rejected":
                record.approval_state = "draft"


class PetroraqEstimationLine(models.Model):
    _name = "petroraq.estimation.line"
    _description = "Estimation Line"
    _order = "section_type, id"

    estimation_id = fields.Many2one(
        "petroraq.estimation",
        string="Estimation",
        required=True,
        ondelete="cascade",
    )
    section_type = fields.Selection(SECTION_TYPES, string="Section", required=True)
    product_id = fields.Many2one("product.product", string="Product")
    name = fields.Char(string="Description")
    quantity = fields.Float(string="Quantity", default=1.0)
    uom_id = fields.Many2one("uom.uom", string="Unit of Measure")
    currency_id = fields.Many2one(
        "res.currency",
        related="estimation_id.currency_id",
        store=True,
        readonly=True,
    )
    unit_cost = fields.Monetary(string="Unit Cost", currency_field="currency_id")
    subtotal = fields.Monetary(
        string="Subtotal",
        currency_field="currency_id",
        compute="_compute_subtotal",
        store=False,
    )

    @api.onchange("product_id")
    def _onchange_product_id(self):
        for line in self:
            if not line.product_id:
                continue
            line.name = line.product_id.display_name
            line.uom_id = line.product_id.uom_id
            line.unit_cost = line.product_id.standard_price

    @api.depends("quantity", "unit_cost")
    def _compute_subtotal(self):
        for line in self:
            line.subtotal = (line.quantity or 0.0) * (line.unit_cost or 0.0)