<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="report_saleorder_document_petroraq_costing"
              inherit_id="sale.report_saleorder_document">

        <!-- Remove taxes column -->
        <xpath expr="//th[@name='th_taxes']" position="replace"/>
        <xpath expr="//td[@name='td_taxes']" position="replace"/>

        <!-- ==============================
             UNIT PRICE (Costing) - ROUNDED
             ============================== -->
        <xpath expr="//td[@name='td_priceunit']/span" position="replace">
            <t t-if="not line.display_type">
                <t t-set="base" t-value="line.price_unit or 0.0"/>
                <t t-set="oh" t-value="base * (doc.overhead_percent or 0.0) / 100.0"/>
                <t t-set="risk" t-value="base * (doc.risk_percent or 0.0) / 100.0"/>
                <t t-set="unit_or" t-value="base + oh + risk"/>
                <t t-set="profit" t-value="unit_or * (doc.profit_percent or 0.0) / 100.0"/>
                <t t-set="final_unit" t-value="unit_or + profit"/>

                <!-- IMPORTANT: round unit like accounting -->
                <t t-set="final_unit_r" t-value="doc.currency_id.round(final_unit)"/>

                <span t-out="final_unit_r"
                      t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
            </t>
        </xpath>

        <!-- Rename Amount column -->
        <xpath expr="//th[@name='th_subtotal']/span" position="replace">
            <span>Total</span>
        </xpath>

        <!-- ==========================
             LINE TOTAL - ROUNDED
             total = round( round(unit) * qty )
             ========================== -->
        <xpath expr="//td[@name='td_subtotal']/span" position="replace">
            <t t-if="not line.display_type">
                <t t-set="base" t-value="line.price_unit or 0.0"/>
                <t t-set="oh" t-value="base * (doc.overhead_percent or 0.0) / 100.0"/>
                <t t-set="risk" t-value="base * (doc.risk_percent or 0.0) / 100.0"/>
                <t t-set="unit_or" t-value="base + oh + risk"/>
                <t t-set="profit" t-value="unit_or * (doc.profit_percent or 0.0) / 100.0"/>
                <t t-set="final_unit" t-value="unit_or + profit"/>

                <t t-set="final_unit_r" t-value="doc.currency_id.round(final_unit)"/>
                <t t-set="final_total" t-value="doc.currency_id.round(final_unit_r * (line.product_uom_qty or 0.0))"/>

                <span t-out="final_total"
                      t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
            </t>
        </xpath>

        <!-- ==================================================
             SECTION SUBTOTAL accumulator - MUST match line total
             current_subtotal += round(round(unit)*qty)
             ================================================== -->
        <xpath expr="//t[@t-set='current_subtotal' and contains(@t-value, 'line.price_subtotal')]" position="replace">
            <t t-if="not line.display_type">
                <t t-set="base" t-value="line.price_unit or 0.0"/>
                <t t-set="oh" t-value="base * (doc.overhead_percent or 0.0) / 100.0"/>
                <t t-set="risk" t-value="base * (doc.risk_percent or 0.0) / 100.0"/>
                <t t-set="unit_or" t-value="base + oh + risk"/>
                <t t-set="profit" t-value="unit_or * (doc.profit_percent or 0.0) / 100.0"/>
                <t t-set="final_unit" t-value="unit_or + profit"/>

                <t t-set="final_unit_r" t-value="doc.currency_id.round(final_unit)"/>
                <t t-set="line_total_r" t-value="doc.currency_id.round(final_unit_r * (line.product_uom_qty or 0.0))"/>

                <t t-set="current_subtotal" t-value="current_subtotal + line_total_r"/>
            </t>
        </xpath>

        <!-- ==========================
             SUMMARY TOTALS (Costing)
             built from SAME rounded line totals
             ========================== -->
        <xpath expr="//t[@t-call='sale.document_tax_totals']" position="replace">

            <!-- ONLY normal lines (exclude sections/notes + down payments) -->
            <t t-set="normal_lines"
               t-value="[l for l in lines_to_report if (not l.display_type) and (not l.is_downpayment)]"/>

            <!-- total from rounded line totals -->
            <t t-set="final_total" t-value="0.0"/>

            <t t-foreach="normal_lines" t-as="l">
                <t t-set="base" t-value="l.price_unit or 0.0"/>
                <t t-set="oh" t-value="base * (doc.overhead_percent or 0.0) / 100.0"/>
                <t t-set="risk" t-value="base * (doc.risk_percent or 0.0) / 100.0"/>
                <t t-set="unit_or" t-value="base + oh + risk"/>
                <t t-set="profit" t-value="unit_or * (doc.profit_percent or 0.0) / 100.0"/>
                <t t-set="final_unit" t-value="unit_or + profit"/>

                <t t-set="final_unit_r" t-value="doc.currency_id.round(final_unit)"/>
                <t t-set="line_total_r" t-value="doc.currency_id.round(final_unit_r * (l.product_uom_qty or 0.0))"/>

                <t t-set="final_total" t-value="final_total + line_total_r"/>
            </t>

            <!-- VAT / Grand total -->
            <t t-set="vat_amt" t-value="final_total * 0.15"/>
            <t t-set="vat_amt_r" t-value="doc.currency_id.round(vat_amt)"/>
            <t t-set="grand_total_with_vat" t-value="final_total + vat_amt_r"/>

            <tbody>
                <tr>
                    <td class="text-end">
                        <strong>Total Price</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="final_total"
                              t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                </tr>
                <tr>
                    <td class="text-end">
                        <strong>15% VAT Amount</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="vat_amt_r"
                              t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                </tr>
                <tr>
                    <td class="text-end">
                        <strong>Net Total:</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="grand_total_with_vat"
                              t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                </tr>
            </tbody>

        </xpath>

    </template>
</odoo>
