<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="report_saleorder_document_petroraq_costing"
              inherit_id="sale.report_saleorder_document">

        <!-- Remove taxes column -->
        <xpath expr="//th[@name='th_taxes']" position="replace"/>
        <xpath expr="//td[@name='td_taxes']" position="replace"/>

        <!-- Rename Amount column header -->
        <xpath expr="//th[@name='th_subtotal']/span" position="replace">
            <span>Total</span>
        </xpath>

        <!-- FORCE VAT block (no Odoo taxes) -->
        <!-- FORCE VAT block (no Odoo taxes) -->
        <xpath expr="//t[@t-call='sale.document_tax_totals']" position="replace">
            <t t-set="currency" t-value="doc.currency_id"/>
            <t t-set="rounding_method" t-value="doc.company_id.tax_calculation_rounding_method"/>

            <!-- Only normal lines (exclude sections/notes + DP lines) -->
            <t t-set="normal_lines"
               t-value="[l for l in lines_to_report if (not l.display_type) and (not l.is_downpayment)]"/>

            <t t-set="gross_total" t-value="0.0"/>   <!-- before discount -->
            <t t-set="net_total" t-value="0.0"/>     <!-- after discount (subtotal) -->
            <t t-set="vat_sum" t-value="0.0"/>

            <t t-foreach="normal_lines" t-as="l">
                <t t-set="qty" t-value="l.product_uom_qty or 0.0"/>

                <!-- gross line (before discount) -->
                <t t-set="line_gross" t-value="currency.round((l.price_unit or 0.0) * qty)"/>
                <t t-set="gross_total" t-value="gross_total + line_gross"/>

                <!-- net line (after discount) -->
                <t t-set="line_net" t-value="currency.round(l.price_subtotal or 0.0)"/>
                <t t-set="net_total" t-value="net_total + line_net"/>

                <!-- VAT rounding method -->
                <t t-if="rounding_method == 'round_per_line'">
                    <t t-set="vat_sum" t-value="vat_sum + currency.round(line_net * 0.15)"/>
                </t>
            </t>

            <!-- global rounding VAT -->
            <t t-if="rounding_method != 'round_per_line'">
                <t t-set="vat_sum" t-value="currency.round(net_total * 0.15)"/>
            </t>

            <t t-set="discount_sum" t-value="currency.round(gross_total - net_total)"/>
            <t t-set="grand_total_with_vat" t-value="currency.round(net_total + vat_sum)"/>

            <tbody>

                <!-- ✅ NEW: show gross total first -->
                <tr t-if="discount_sum">
                    <td>
                        <strong>Amount Before Discount</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="gross_total"
                              t-options="{'widget':'monetary','display_currency':currency}"/>
                    </td>
                </tr>

                <!-- ✅ show discount as minus -->
                <tr t-if="discount_sum">
                    <td>
                        <strong>Discount</strong>
                    </td>
                    <td class="text-end">
                        <span>-</span>
                        <span t-out="discount_sum"
                              t-options="{'widget':'monetary','display_currency':currency}"/>
                    </td>
                </tr>

                <!-- keep your label, but now it's NET (after discount) -->
                <tr>
                    <td>
                        <strong>Total Price</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="net_total"
                              t-options="{'widget':'monetary','display_currency':currency}"/>
                    </td>
                </tr>

                <!-- Pro-forma advance -->
                <tr t-if="is_pro_forma">
                    <td>
                        <strong t-out="doc.proforma_dp"/>
                        <strong>% Advance</strong>
                    </td>
                    <td class="text-end">
                        <t t-set="adv_amt"
                           t-value="currency.round((net_total or 0.0) * (doc.proforma_dp or 0.0) / 100.0)"/>
                        <span t-out="adv_amt"
                              t-options="{'widget':'monetary','display_currency':currency}"/>
                    </td>
                </tr>

                <tr t-if="not is_pro_forma">
                    <td>
                        <strong>15% VAT Amount</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="vat_sum"
                              t-options="{'widget':'monetary','display_currency':currency}"/>
                    </td>
                </tr>

                <tr t-if="not is_pro_forma">
                    <td>
                        <strong>Net Total:</strong>
                    </td>
                    <td class="text-end">
                        <span t-out="grand_total_with_vat"
                              t-options="{'widget':'monetary','display_currency':currency}"/>
                    </td>
                </tr>

            </tbody>
        </xpath>

    </template>
</odoo>
