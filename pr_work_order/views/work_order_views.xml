<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="view_pr_work_order_tree" model="ir.ui.view">
        <field name="name">pr.work.order.tree</field>
        <field name="model">pr.work.order</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name"/>
                <field name="sale_order_id"/>
                <field name="partner_id"/>
                <field name="project_id"/>
                <field name="analytic_account_id"/>
                <field name="contract_amount"/>
                <field name="actual_cost"/>
                <field name="actual_margin"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="view_pr_work_order_form" model="ir.ui.view">
        <field name="name">pr.work.order.form</field>
        <field name="model">pr.work.order</field>
        <field name="arch" type="xml">
            <form string="Work Order">

                <!-- ==========================================
                     HEADER BUTTONS WITH VALID GROUP RULES
                =========================================== -->

                <header>

                    <button name="action_submit_ops" type="object" string="Submit to Operations"
                            class="btn-primary"
                            groups="pr_work_order.custom_group_work_order_user,
                                    pr_work_order.custom_group_work_order_operations,
                                    pr_work_order.custom_group_work_order_accounts,
                                    pr_work_order.custom_group_work_order_management"
                            invisible="state != 'draft'"/>

                    <button name="action_ops_approve" type="object" string="Operations Approve"
                            class="btn-primary"
                            groups="pr_work_order.custom_group_work_order_operations"
                            invisible="state != 'ops_approval'"/>

                    <button name="action_acc_approve" type="object" string="Accounts Approve"
                            class="btn-primary"
                            groups="pr_work_order.custom_group_work_order_accounts"
                            invisible="state != 'acc_approval'"/>

                    <button name="action_final_approve" type="object" string="Final Approve"
                            class="btn-primary"
                            groups="pr_work_order.custom_group_work_order_management"
                            invisible="state != 'final_approval'"/>

                    <button name="action_start_operations" type="object" string="Start Operations"
                            class="btn-secondary"
                            groups="pr_work_order.custom_group_work_order_operations,
                                    pr_work_order.custom_group_work_order_management"
                            invisible="state not in ['approved','in_progress']"/>

                    <button name="action_mark_done" type="object" string="Mark Done"
                            class="btn-success"
                            groups="pr_work_order.custom_group_work_order_management"
                            invisible="state != 'in_progress'"/>

                    <button name="action_cancel" type="object" string="Cancel"
                            class="btn-secondary"
                            groups="pr_work_order.custom_group_work_order_management"
                            invisible="state in ['done','cancel']"/>

                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,ops_approval,acc_approval,final_approval,approved,in_progress,done,cancel"/>
                </header>


                <!-- ==========================================
                      BODY
                =========================================== -->

                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="company_id"/>
                            <field name="sale_order_id"/>
                            <field name="partner_id" readonly="1"/>
                            <field name="po_number"/>
                            <field name="project_id"/>
                            <field name="analytic_account_id"/>
                            <field name="date_start"/>
                            <field name="date_end"/>
                        </group>

                        <group string="Budget / Financials">
                            <field name="contract_amount"
                                   groups="pr_work_order.custom_group_work_order_accounts,pr_work_order.custom_group_work_order_management"/>
                            <field name="budgeted_cost"
                                   groups="pr_work_order.custom_group_work_order_operations,pr_work_order.custom_group_work_order_management"/>
                            <field name="budgeted_margin" readonly="1"/>
                            <field name="actual_revenue" readonly="1"/>
                            <field name="actual_cost" readonly="1"/>
                            <field name="actual_margin" readonly="1"/>
                        </group>
                    </group>


                    <!-- ==========================================
                          NOTEBOOK PAGES
                    =========================================== -->

                    <notebook>

                        <!-- TASKS (editable only by OPERATIONS + MANAGEMENT) -->
                        <page string="Tasks"
                              groups="pr_work_order.custom_group_work_order_operations,pr_work_order.custom_group_work_order_management">
                            <field name="task_ids">
                                <tree editable="bottom">
                                    <field name="name"/>
                                    <field name="project_id"/>
                                    <field name="company_id"/>
                                    <field name="stage_id"/>
                                    <field name="allocated_hours"/>
                                    <field name="working_hours_open"/>
                                    <field name="working_hours_close"/>
                                </tree>

                                <form>
                                    <sheet>
                                        <group>
                                            <field name="name"/>
                                            <field name="project_id"/>
                                            <field name="company_id"/>
                                            <field name="work_order_id"/>
                                            <field name="activity_user_id"/>
                                            <field name="allocated_hours"/>
                                            <field name="working_hours_open"/>
                                            <field name="working_hours_close"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>


                        <!-- BOQ -->
                        <page string="BOQ / Budget"
                              groups="pr_work_order.custom_group_work_order_operations,pr_work_order.custom_group_work_order_management">
                            <field name="boq_line_ids" widget="section_and_note_one2many">
                                <tree editable="bottom" create="0" delete="0">
                                    <field name="display_type" column_invisible="1"/>
                                    <field name="name" readonly="1" widget="section_and_note_text"/>
                                    <field name="product_id" readonly="1"/>
                                    <field name="qty"/>
                                    <field name="unit_cost"/>
                                    <field name="total" readonly="1"/>
                                </tree>
                            </field>
                        </page>


                        <!-- COST CENTERS -->
                        <page string="Cost Centers"
                              groups="pr_work_order.custom_group_work_order_operations,pr_work_order.custom_group_work_order_management">
                            <field name="cost_center_ids">
                                <tree editable="bottom" create="0" delete="0">
                                    <field name="sequence"/>
                                    <field name="section_name" readonly="1"/>
                                    <field name="analytic_account_id"/>
                                    <field name="department_id"/>
                                    <field name="section_id"/>
                                    <field name="estimated_cost" readonly="1"/>
                                </tree>
                            </field>
                        </page>


                        <!-- READONLY PAGES -->
                        <page string="Material Movements">
                            <field name="stock_move_ids" readonly="1">
                                <tree>
                                    <field name="picking_id"/>
                                    <field name="product_id"/>
                                    <field name="location_id"/>
                                    <field name="location_dest_id"/>
                                    <field name="product_qty"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </page>

                        <page string="Invoices / Bills">
                            <group>
                                <field name="customer_invoice_ids" readonly="1"/>
                                <field name="vendor_bill_ids" readonly="1"/>
                            </group>
                        </page>

                        <page string="Labour / Timesheets">
                            <field name="labour_ids" readonly="1"/>
                        </page>
                        <page string="Budget"
                              groups="pr_work_order.custom_group_work_order_operations, pr_work_order.custom_group_work_order_accounts">
                            <group>
                                <field name="budget_id" readonly="1"/>
                            </group>

                            <group>
                                <field name="budget_id">
                                    <form>
                                        <sheet>
                                            <group>
                                                <field name="name"/>
                                                <field name="date_from"/>
                                                <field name="date_to"/>
                                                <field name="user_id"/>
                                            </group>

                                            <notebook>
                                                <page string="Budget Lines">
                                                    <field name="crossovered_budget_line">
                                                        <tree editable="bottom">
                                                            <field name="analytic_account_id"/>
                                                            <field name="date_from"/>
                                                            <field name="date_to"/>
                                                            <field name="planned_amount"/>
                                                        </tree>
                                                    </field>
                                                </page>
                                            </notebook>
                                        </sheet>
                                    </form>
                                </field>
                            </group>
                        </page>


                        <page string="Approvals">
                            <group>
                                <group string="Operations">
                                    <field name="ops_approver_id" readonly="1"/>
                                    <field name="ops_approved_date" readonly="1"/>
                                </group>
                                <group string="Accounts">
                                    <field name="acc_approver_id" readonly="1"/>
                                    <field name="acc_approved_date" readonly="1"/>
                                </group>
                                <group string="Final">
                                    <field name="final_approver_id" readonly="1"/>
                                    <field name="final_approved_date" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Notes">
                            <group>
                                <field name="equipment_note" groups="pr_work_order.custom_group_work_order_management"/>
                                <field name="materials_note" groups="pr_work_order.custom_group_work_order_management"/>
                                <field name="note" groups="pr_work_order.custom_group_work_order_management"/>
                            </group>
                        </page>

                    </notebook>

                </sheet>

            </form>
        </field>
    </record>

    <record id="action_pr_work_order" model="ir.actions.act_window">
        <field name="name">Work Orders</field>
        <field name="res_model">pr.work.order</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p>Create and manage construction work orders linked with Sales, Projects, Accounting and Inventory.</p>
        </field>
    </record>

</odoo>
